# .github/workflows/release.yml
name: Windows Release Build

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: |
          pipx install poetry
          poetry --version

      - name: Validate poetry project
        run: |
          poetry check

      - name: Install dependencies
        run: |
          poetry install --no-interaction

      - name: Extract version from tag
        id: get_version
        run: |
          $tag = "${{ github.ref_name }}"
          $ver = $tag.TrimStart("v")
          "version=$ver" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Host "TAG VERSION => $ver"

      # ✅ tag 버전을 version.py에 주입 (__VERSION__ 토큰 치환)
      - name: Inject version into src/app/version.py
        run: |
          $ver  = "${{ steps.get_version.outputs.version }}"
          $path = "src/app/version.py"
          if (-not (Test-Path $path)) { throw "version.py not found: $path" }

          $raw = Get-Content $path -Raw
          $raw = $raw -replace '"__VERSION__"', ('"' + $ver + '"')

          # UTF-8 no BOM 저장
          [System.IO.File]::WriteAllText($path, $raw, (New-Object System.Text.UTF8Encoding($false)))

          Write-Host "Injected version.py => $ver"
          Get-Content $path | Select-Object -First 60

      - name: Clean dist/build
        run: |
          if (Test-Path "dist")  { Remove-Item "dist"  -Recurse -Force }
          if (Test-Path "build") { Remove-Item "build" -Recurse -Force }

      - name: Verify spec exists
        run: |
          if (-not (Test-Path "KakaoSender.spec")) {
            throw "KakaoSender.spec not found at repo root."
          }

      - name: Build EXE (PyInstaller - spec only)
        run: |
          poetry run pyinstaller -y --clean `
            --distpath dist/app `
            --workpath build/pyinstaller `
            KakaoSender.spec

      # ✅ dist 전체 트리 출력(문제 추적용)
      - name: Debug - show dist tree
        run: |
          Write-Host "----- dist tree -----"
          if (Test-Path dist) { Get-ChildItem -Recurse dist | Select-Object FullName }
          else { Write-Host "dist not found" }

      - name: Verify build artifacts
        run: |
          $exePath = "dist/app/KakaoCampaignSender/KakaoCampaignSender.exe"
          if (-not (Test-Path $exePath)) {
            Write-Host "----- dist/app tree -----"
            if (Test-Path "dist/app") { Get-ChildItem -Recurse "dist/app" | Select-Object FullName }
            throw "Expected EXE not found: $exePath"
          }
          Write-Host "OK: $exePath"

      - name: Install Inno Setup
        run: |
          choco install innosetup -y
          if (-not (Test-Path "C:\Program Files (x86)\Inno Setup 6\ISCC.exe")) {
            throw "ISCC.exe not found after install."
          }

      - name: Verify installer inputs
        run: |
          if (-not (Test-Path "installer/KakaoCampaignSender.iss")) { throw "installer/KakaoCampaignSender.iss not found." }
          if (-not (Test-Path "installer/KakaoSender.ico")) { throw "installer/KakaoSender.ico not found." }
          Get-ChildItem installer | Select-Object FullName,Length

      # ✅ Inno에 OutputDir + MyAppDistDir 절대경로로 주입 (CI에서 가장 안정적)
      - name: Compile Installer
        run: |
          $ver    = "${{ steps.get_version.outputs.version }}"
          $outDir = Join-Path $pwd "dist\installer"
          $appDir = Join-Path $pwd "dist\app\KakaoCampaignSender"

          if (-not (Test-Path $outDir)) { New-Item -ItemType Directory -Force -Path $outDir | Out-Null }
          if (-not (Test-Path $appDir)) { throw "MyAppDistDir missing: $appDir" }

          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" `
            /DMyAppVersion=$ver `
            /DOutputDir="$outDir" `
            /DMyAppDistDir="$appDir" `
            /DMyAppIconSource="$icoPath" `   # ✅ 추가
            /E"dist\installer\preprocessed.iss" `   # ✅ 전처리 결과 덤프
            "installer\KakaoCampaignSender.iss"

      - name: Verify installer output
        run: |
          $ver = "${{ steps.get_version.outputs.version }}"
          $pattern = "KakaoCampaignSenderSetup_$ver.exe"
          $installer = Get-ChildItem "dist/installer" -Filter $pattern -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $installer) {
            Write-Host "----- dist/installer tree -----"
            if (Test-Path "dist/installer") { Get-ChildItem -Recurse "dist/installer" | Select-Object FullName }
            throw "Installer not found: dist/installer/$pattern"
          }
          Write-Host "OK: $($installer.FullName)"

      - name: Generate sha256 + latest.json
        run: |
          $ver = "${{ steps.get_version.outputs.version }}"
          $installer = Get-ChildItem "dist/installer" -Filter "KakaoCampaignSenderSetup_$ver.exe" | Select-Object -First 1
          if (-not $installer) { throw "Installer not found for latest.json" }

          $hash = (Get-FileHash $installer.FullName -Algorithm SHA256).Hash.ToLower()
          $url  = "https://github.com/${{ github.repository }}/releases/download/v$ver/$($installer.Name)"

          $obj = [ordered]@{
            version      = $ver
            url          = $url
            sha256       = $hash
            notes        = ""
            published_at = (Get-Date).ToUniversalTime().ToString("o")
          }

          ($obj | ConvertTo-Json -Depth 5) | Out-File -Encoding utf8 "dist/installer/latest.json"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/installer/*.exe
            dist/installer/latest.json
          generate_release_notes: true