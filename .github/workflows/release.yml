name: release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: |
          pipx install poetry

      - name: Install deps
        run: |
          poetry --version
          poetry install --no-interaction

      - name: Extract version from tag
        id: ver
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $ver = $tag.TrimStart("v")
          echo "version=$ver" >> $env:GITHUB_OUTPUT

      - name: Set version.py (optional)
        shell: pwsh
        run: |
          $ver="${{ steps.ver.outputs.version }}"
          (Get-Content "src/app/version.py") `
            -replace '__version__\s*=\s*".*"', ('__version__ = "'+$ver+'"') `
            | Set-Content "src/app/version.py"

      - name: Build exe with PyInstaller
        shell: pwsh
        run: |
          poetry run pyinstaller -n KakaoCampaignSender -w -m app.main --clean --noconfirm --distpath dist/app

      - name: Install Inno Setup
        shell: pwsh
        run: |
          choco install innosetup -y

      - name: Compile installer
        shell: pwsh
        run: |
          $ver="${{ steps.ver.outputs.version }}"
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" /DMyAppVersion=$ver installer\KakaoCampaignSender.iss

      - name: Compute sha256 + create latest.json
        shell: pwsh
        run: |
          $ver="${{ steps.ver.outputs.version }}"
          $installer = Get-ChildItem "dist/installer" -Filter "*Setup_$ver.exe" | Select-Object -First 1
          if (-not $installer) { throw "Installer not found" }

          $hash = (Get-FileHash $installer.FullName -Algorithm SHA256).Hash.ToLower()
          $url = "https://github.com/${{ github.repository }}/releases/download/v$ver/$($installer.Name)"

          $obj = [ordered]@{
            version      = $ver
            url          = $url
            sha256       = $hash
            notes        = ""
            published_at = (Get-Date).ToUniversalTime().ToString("o")
          }
          $json = ($obj | ConvertTo-Json -Depth 5)
          $json | Out-File -Encoding utf8 "dist/installer/latest.json"

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/installer/*.exe
            dist/installer/latest.json
          generate_release_notes: true