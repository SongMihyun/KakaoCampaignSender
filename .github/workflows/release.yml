name: Windows Release Build

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        shell: pwsh
        run: |
          pipx install poetry
          poetry --version

      # ✅ (권장) 프로젝트/pyproject/lock 상태 점검
      - name: Validate poetry project
        shell: pwsh
        run: |
          poetry check

      - name: Install dependencies
        shell: pwsh
        run: |
          poetry install --no-interaction

      - name: Extract version from tag
        id: get_version
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $ver = $tag.TrimStart("v")
          "version=$ver" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      # ✅ dist/build 완전 청소 (이중 산출물 방지 핵심)
      - name: Clean dist/build
        shell: pwsh
        run: |
          if (Test-Path "dist")  { Remove-Item "dist"  -Recurse -Force }
          if (Test-Path "build") { Remove-Item "build" -Recurse -Force }

      # ✅ spec 파일 존재 검증 (예: "KakaoSender.spec")
      - name: Verify spec exists
        shell: pwsh
        run: |
          if (-not (Test-Path "KakaoSender.spec")) {
            throw "KakaoSender.spec not found at repo root. Commit it and ensure the filename matches."
          }

      # ✅ PyInstaller: spec 방식 ONLY + distpath 고정 => dist/app/KakaoCampaignSender
      - name: Build EXE (PyInstaller - spec only)
        shell: pwsh
        run: |
          poetry run pyinstaller -y --clean --distpath dist/app KakaoSender.spec

      # ✅ 산출물 경로 검증(완전 통일 기준)
      - name: Verify build artifacts
        shell: pwsh
        run: |
          $exePath = "dist/app/KakaoCampaignSender/KakaoCampaignSender.exe"
          if (-not (Test-Path $exePath)) {
            Write-Host "----- dist/app tree -----"
            if (Test-Path "dist/app") { Get-ChildItem -Recurse "dist/app" | Select-Object FullName }
            throw "Expected EXE not found: $exePath"
          }
          Write-Host "OK: $exePath"

      - name: Install Inno Setup
        shell: pwsh
        run: |
          choco install innosetup -y
          if (-not (Test-Path "C:\Program Files (x86)\Inno Setup 6\ISCC.exe")) {
            throw "ISCC.exe not found after install."
          }

      # ✅ iss 파일 존재 검증
      - name: Verify installer script exists
        shell: pwsh
        run: |
          if (-not (Test-Path "installer/KakaoCampaignSender.iss")) {
            throw "installer/KakaoCampaignSender.iss not found."
          }

      # ✅ Installer 컴파일 (버전 주입)
      - name: Compile Installer
        shell: pwsh
        run: |
          $ver = "${{ steps.get_version.outputs.version }}"
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" /DMyAppVersion=$ver "installer\KakaoCampaignSender.iss"

      # ✅ 인스톨러 산출물 검증
      - name: Verify installer output
        shell: pwsh
        run: |
          $ver = "${{ steps.get_version.outputs.version }}"
          $pattern = "KakaoCampaignSenderSetup_$ver.exe"
          $installer = Get-ChildItem "dist/installer" -Filter $pattern -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $installer) {
            Write-Host "----- dist/installer tree -----"
            if (Test-Path "dist/installer") { Get-ChildItem -Recurse "dist/installer" | Select-Object FullName }
            throw "Installer not found: dist/installer/$pattern"
          }
          Write-Host "OK: $($installer.FullName)"

      # ✅ latest.json + sha256 생성
      - name: Generate sha256 + latest.json
        shell: pwsh
        run: |
          $ver = "${{ steps.get_version.outputs.version }}"
          $installer = Get-ChildItem "dist/installer" -Filter "KakaoCampaignSenderSetup_$ver.exe" | Select-Object -First 1
          if (-not $installer) { throw "Installer not found for latest.json" }

          $hash = (Get-FileHash $installer.FullName -Algorithm SHA256).Hash.ToLower()
          $url = "https://github.com/${{ github.repository }}/releases/download/v$ver/$($installer.Name)"

          $obj = [ordered]@{
            version      = $ver
            url          = $url
            sha256       = $hash
            notes        = ""
            published_at = (Get-Date).ToUniversalTime().ToString("o")
          }

          $json = ($obj | ConvertTo-Json -Depth 5)
          $json | Out-File -Encoding utf8 "dist/installer/latest.json"

      # ✅ GitHub Release 생성 + 산출물 업로드
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/installer/*.exe
            dist/installer/latest.json
          generate_release_notes: true